generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Project {
  id            String            @id @default(uuid()) @db.Uuid
  title         String
  status        ProjectStatus     @default(IDEA)
  descriptionMd String            @default("")
  yarnPlan      String            @default("")
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  startedAt     DateTime?
  finishedAt    DateTime?
  archivedAt    DateTime?

  basedOnProjectId String?   @db.Uuid
  basedOn          Project?  @relation("ProjectBasedOn", fields: [basedOnProjectId], references: [id], onDelete: SetNull)
  derivedProjects  Project[] @relation("ProjectBasedOn")

  photos        Photo[]
  logEntries    ProjectLogEntry[]
  tags          ProjectTag[]

  @@index([status])
  @@index([archivedAt])
  @@index([basedOnProjectId])
}

model ProjectLogEntry {
  id         String   @id @default(uuid()) @db.Uuid
  projectId  String   @db.Uuid
  happenedAt DateTime @default(now())
  title      String
  contentMd  String   @default("")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  photos     Photo[]
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, happenedAt(sort: Desc)])
}

model Tag {
  id       String       @id @default(uuid()) @db.Uuid
  name     String       @unique
  color    String?
  projects ProjectTag[]
  createdAt DateTime @default(now())
}

model ProjectTag {
  projectId String   @db.Uuid
  tagId     String   @db.Uuid
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([projectId, tagId])
  @@index([tagId])
}

model Photo {
  id         String           @id @default(uuid()) @db.Uuid
  uri        String
  caption    String           @default("")
  alt        String?
  role       PhotoRole        @default(GALLERY)
  sortOrder  Int              @default(0)
  createdAt  DateTime         @default(now())
  projectId  String?          @db.Uuid
  logEntryId String?          @db.Uuid
  logEntry   ProjectLogEntry? @relation(fields: [logEntryId], references: [id], onDelete: Cascade)
  project    Project?         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([logEntryId])
}

enum ProjectStatus {
  IDEA
  ACTIVE
  PAUSED
  FINISHED
  ABANDONED
}

enum PhotoRole {
  COVER
  GALLERY
}
