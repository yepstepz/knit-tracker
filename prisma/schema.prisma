generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Project {
  id            String        @id @default(uuid()) @db.Uuid
  title         String
  status        ProjectStatus @default(IDEA)
  descriptionMd String        @default("")
  yarnPlan      String        @default("")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  startedAt     DateTime?
  finishedAt    DateTime?
  archivedAt    DateTime?

  basedOnProjectId String?   @db.Uuid
  basedOn          Project?  @relation("ProjectBasedOn", fields: [basedOnProjectId], references: [id], onDelete: SetNull)
  derivedProjects  Project[] @relation("ProjectBasedOn")

  photos     Photo[]
  logEntries ProjectLogEntry[]
  tags       ProjectTag[]

  @@index([status])
  @@index([archivedAt])
  @@index([basedOnProjectId])
}

model ProjectLogEntry {
  id         String   @id @default(uuid()) @db.Uuid
  projectId  String   @db.Uuid
  happenedAt DateTime @default(now())
  title      String
  contentMd  String   @default("")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  photo      Photo?   @relation("LogEntryPhoto")
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, happenedAt(sort: Desc)])
}

model Tag {
  id        String       @id @default(uuid()) @db.Uuid
  name      String       @unique
  color     String?
  projects  ProjectTag[]
  createdAt DateTime     @default(now())
}

model ProjectTag {
  projectId String   @db.Uuid
  tagId     String   @db.Uuid
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([projectId, tagId])
  @@index([tagId])
}

model Photo {
  id         String           @id @default(uuid()) @db.Uuid
  uri        String
  caption    String           @default("")
  alt        String?
  role       PhotoRole        @default(GALLERY)
  sortOrder  Int              @default(0)
  createdAt  DateTime         @default(now())
  projectId  String?          @db.Uuid
  logEntryId String?          @unique @db.Uuid
  logEntry   ProjectLogEntry? @relation("LogEntryPhoto", fields: [logEntryId], references: [id], onDelete: Cascade)
  project    Project?         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

enum ProjectStatus {
  IDEA
  ACTIVE
  PAUSED
  FINISHED
  ABANDONED
}

enum PhotoRole {
  COVER
  GALLERY
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         String   @default("admin")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
